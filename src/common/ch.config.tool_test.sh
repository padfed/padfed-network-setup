#!/bin/bash
[[ -n $DEBUG ]] && set -x
set -Eeuo pipefail

readonly BASE="$(dirname "$(readlink -f "$0")")"
. "$BASE/lib.sh"

echo_running

function mocks() {

  mkdir -p "$BASE/tmp"

  for f in padfed.config.json bConnect.config.json orgx.json; do
    check_file "$BASE/test/$f"
  done

  readonly PADFED_CONFIG_JSON="$BASE/tmp/$$.padfed.config.json"
  readonly BCONNECT_CONFIG_JSON="$BASE/tmp/$$.bConnect.config.json"
  readonly ORGX_JSON="$BASE/tmp/$$.orgx.json"

  cp "$BASE/test/padfed.config.json"   "$PADFED_CONFIG_JSON"
  cp "$BASE/test/bConnect.config.json" "$BCONNECT_CONFIG_JSON"
  cp "$BASE/test/orgx.json"            "$ORGX_JSON"

  readonly KV_FILE="$BASE/tmp/$$.kv_file"
  local kv='
absolute_max_bytes=5242880
max_message_count=9999
preferred_max_bytes=4194304
tick_interval="99ms"
'
  echo "$kv" > "$KV_FILE"
  unset kv

readonly BASE64_CRT="LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNZVENDQWdpZ0F3SUJBZ0lSQUp4M09FNnNtNWZPd2JLZFVZcjFyem93Q2dZSUtvWkl6ajBFQXdJd2V6RUwKTUFrR0ExVUVCaE1DUVZJeERUQUxCZ05WQkFnVEJFTkJRa0V4RFRBTEJnTlZCQWNUQkVOQlFrRXhIREFhQmdOVgpCQW9URTJGbWFYQXVkSEpwWW1abFpDNW5iMkl1WVhJeER6QU5CZ05WQkFzVEJsTkVSMU5KVkRFZk1CMEdBMVVFCkF4TVdZMkV1WVdacGNDNTBjbWxpWm1Wa0xtZHZZaTVoY2pBZUZ3MHhPVEV3TURReE5qSXlNREJhRncweU9URXcKTURFeE5qSXlNREJhTUhzeEN6QUpCZ05WQkFZVEFrRlNNUTB3Q3dZRFZRUUlFd1JEUVVKQk1RMHdDd1lEVlFRSApFd1JEUVVKQk1Sd3dHZ1lEVlFRS0V4TmhabWx3TG5SeWFXSm1aV1F1WjI5aUxtRnlNUTh3RFFZRFZRUUxFd1pUClJFZFRTVlF4SHpBZEJnTlZCQU1URm1OaExtRm1hWEF1ZEhKcFltWmxaQzVuYjJJdVlYSXdXVEFUQmdjcWhrak8KUFFJQkJnZ3Foa2pPUFFNQkJ3TkNBQVRmK3JsdFNvN1lWdHlma3ZQaUk5MjY1dHQ1UzlIcDhnMnE1eHpoVWNvSgpmWS9RSkpPdlRJbDJFQjNjN1FpRmR4WDJ2TUdjRmxrK0h1OWx0UE9rZkxtZW8yMHdhekFPQmdOVkhROEJBZjhFCkJBTUNBYVl3SFFZRFZSMGxCQll3RkFZSUt3WUJCUVVIQXdJR0NDc0dBUVVGQndNQk1BOEdBMVVkRXdFQi93UUYKTUFNQkFmOHdLUVlEVlIwT0JDSUVJSkdPdU1ycWlFYjZ0MmEzS2NLNWRaL29Nd3A5Nnl2azFYWDM2cXE3WHkvegpNQW9HQ0NxR1NNNDlCQU1DQTBjQU1FUUNJR2tPVCtkWHdLTEFjMVBmVG0zYW9sc2NiRFBFdWlXeEpzbEp5c2NOCmhad2tBaUJwb3A5RE9Cd3ZCWGpHR2xabHpqU3M5WjFUKzlhOXBhdGdJSG1UWVVXVG1nPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="

readonly BASE64_CRT_2="LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNaakNDQWcyZ0F3SUJBZ0lRZW9ycVBFNFRZb3VZSUV0blJoQ3B1VEFLQmdncWhrak9QUVFEQWpCK01Rc3cKQ1FZRFZRUUdFd0pCVWpFTk1Bc0dBMVVFQ0JNRVEwRkNRVEVOTUFzR0ExVUVCeE1FUTBGQ1FURWNNQm9HQTFVRQpDaE1UWVdacGNDNTBjbWxpWm1Wa0xtZHZZaTVoY2pFUE1BMEdBMVVFQ3hNR1UwUkhVMGxVTVNJd0lBWURWUVFECkV4bDBiSE5qWVM1aFptbHdMblJ5YVdKbVpXUXVaMjlpTG1GeU1CNFhEVEU1TURreU9ERTNNVEF3TUZvWERUSTUKTURreU5URTNNVEF3TUZvd2ZqRUxNQWtHQTFVRUJoTUNRVkl4RFRBTEJnTlZCQWdUQkVOQlFrRXhEVEFMQmdOVgpCQWNUQkVOQlFrRXhIREFhQmdOVkJBb1RFMkZtYVhBdWRISnBZbVpsWkM1bmIySXVZWEl4RHpBTkJnTlZCQXNUCkJsTkVSMU5KVkRFaU1DQUdBMVVFQXhNWmRHeHpZMkV1WVdacGNDNTBjbWxpWm1Wa0xtZHZZaTVoY2pCWk1CTUcKQnlxR1NNNDlBZ0VHQ0NxR1NNNDlBd0VIQTBJQUJCMEI0OUpjQlpHcmxOaTY3dFJhVnFCYkJmUzlZN01tay9QVQpKQmhWNjJ0T3RXY05zZkhlbC9JS3U0Q1lQdnRYWkI4c3FmR1JWWUFpaDM0MENlNzN6aUtqYlRCck1BNEdBMVVkCkR3RUIvd1FFQXdJQnBqQWRCZ05WSFNVRUZqQVVCZ2dyQmdFRkJRY0RBZ1lJS3dZQkJRVUhBd0V3RHdZRFZSMFQKQVFIL0JBVXdBd0VCL3pBcEJnTlZIUTRFSWdRZzFkVm9wQnFQc3NWTTJISFQ2WmVuWXlTcEZzR0JhZm95Zk45WQowcTd2bWRzd0NnWUlLb1pJemowRUF3SURSd0F3UkFJZ1N4djNCTU5FTzBWNHZGVkpQUkJxZnY3eTU1K1UreHdHCnIweUZMMGIxdnBzQ0lCa2VZR1JUVjlaM0poNy81ZjJQbEVkNmJ1V0F2Sk9jN0dBSG5DN0ZaV00rCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"

readonly ARRAY_OF_BASE64_CRT="[\"$BASE64_CRT\",\"$BASE64_CRT_2\"]"

readonly CONSENTER='
{
"client_tls_cert": "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNmVENDQWlPZ0F3SUJBZ0lRQWxwN0RrSDhLVXFCOWxUWVlYdGVyVEFLQmdncWhrak9QUVFEQWpCK01Rc3cKQ1FZRFZRUUdFd0pCVWpFTk1Bc0dBMVVFQ0JNRVEwRkNRVEVOTUFzR0ExVUVCeE1FUTBGQ1FURWNNQm9HQTFVRQpDaE1UWVdacGNDNTBjbWxpWm1Wa0xtZHZZaTVoY2pFUE1BMEdBMVVFQ3hNR1UwUkhVMGxVTVNJd0lBWURWUVFECkV4bDBiSE5qWVM1aFptbHdMblJ5YVdKbVpXUXVaMjlpTG1GeU1CNFhEVEU1TVRBd05ERTJNakl3TUZvWERUSTUKTVRBd01URTJNakl3TUZvd1lqRUxNQWtHQTFVRUJoTUNRVkl4RFRBTEJnTlZCQWdUQkVOQlFrRXhEVEFMQmdOVgpCQWNUQkVOQlFrRXhEekFOQmdOVkJBc1RCbE5FUjFOSlZERWtNQ0lHQTFVRUF4TWJiM0prWlhKbGNpNWhabWx3CkxuUnlhV0ptWldRdVoyOWlMbUZ5TUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFcmtUQ2d0L1AKcTU4KzVTUHFmOGtraFNQM1NiZ1g3MzlNMk0vTExTMXNCVTh2VUJCalNZV2VtMlhqNVVXYmN0Y3QycjlaOHM1VQpJWlJDNXpUWDVqYWZZcU9CbmpDQm16QU9CZ05WSFE4QkFmOEVCQU1DQmFBd0hRWURWUjBsQkJZd0ZBWUlLd1lCCkJRVUhBd0VHQ0NzR0FRVUZCd01DTUF3R0ExVWRFd0VCL3dRQ01BQXdLd1lEVlIwakJDUXdJb0FnUDhQSFNVTk0Kc0NDRm5sQ1VBUDczSFNLZjVENUU1UGF0ZXJOWEJXUExkY2t3THdZRFZSMFJCQ2d3Sm9JYmIzSmtaWEpsY2k1aApabWx3TG5SeWFXSm1aV1F1WjI5aUxtRnlnZ2R2Y21SbGNtVnlNQW9HQ0NxR1NNNDlCQU1DQTBnQU1FVUNJUUQ0Cnl5bGlYZDRPaHJpNFA3SG8wMGNBeXFBUXA3azZZdCtZMmwxVmJWbTM4Z0lnTTVWVHhUTEtmeWY4UlNCaTN3SWcKSmJMZVlQeHhjRkFyNzhMVGNWcVhtMTA9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K",
"host": "orderer1.afip.tribfed.gob.ar",
"port": 7050,
"server_tls_cert": "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNmVENDQWlPZ0F3SUJBZ0lRQWxwN0RrSDhLVXFCOWxUWVlYdGVyVEFLQmdncWhrak9QUVFEQWpCK01Rc3cKQ1FZRFZRUUdFd0pCVWpFTk1Bc0dBMVVFQ0JNRVEwRkNRVEVOTUFzR0ExVUVCeE1FUTBGQ1FURWNNQm9HQTFVRQpDaE1UWVdacGNDNTBjbWxpWm1Wa0xtZHZZaTVoY2pFUE1BMEdBMVVFQ3hNR1UwUkhVMGxVTVNJd0lBWURWUVFECkV4bDBiSE5qWVM1aFptbHdMblJ5YVdKbVpXUXVaMjlpTG1GeU1CNFhEVEU1TVRBd05ERTJNakl3TUZvWERUSTUKTVRBd01URTJNakl3TUZvd1lqRUxNQWtHQTFVRUJoTUNRVkl4RFRBTEJnTlZCQWdUQkVOQlFrRXhEVEFMQmdOVgpCQWNUQkVOQlFrRXhEekFOQmdOVkJBc1RCbE5FUjFOSlZERWtNQ0lHQTFVRUF4TWJiM0prWlhKbGNpNWhabWx3CkxuUnlhV0ptWldRdVoyOWlMbUZ5TUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFcmtUQ2d0L1AKcTU4KzVTUHFmOGtraFNQM1NiZ1g3MzlNMk0vTExTMXNCVTh2VUJCalNZV2VtMlhqNVVXYmN0Y3QycjlaOHM1VQpJWlJDNXpUWDVqYWZZcU9CbmpDQm16QU9CZ05WSFE4QkFmOEVCQU1DQmFBd0hRWURWUjBsQkJZd0ZBWUlLd1lCCkJRVUhBd0VHQ0NzR0FRVUZCd01DTUF3R0ExVWRFd0VCL3dRQ01BQXdLd1lEVlIwakJDUXdJb0FnUDhQSFNVTk0Kc0NDRm5sQ1VBUDczSFNLZjVENUU1UGF0ZXJOWEJXUExkY2t3THdZRFZSMFJCQ2d3Sm9JYmIzSmtaWEpsY2k1aApabWx3TG5SeWFXSm1aV1F1WjI5aUxtRnlnZ2R2Y21SbGNtVnlNQW9HQ0NxR1NNNDlCQU1DQTBnQU1FVUNJUUQ0Cnl5bGlYZDRPaHJpNFA3SG8wMGNBeXFBUXA3azZZdCtZMmwxVmJWbTM4Z0lnTTVWVHhUTEtmeWY4UlNCaTN3SWcKSmJMZVlQeHhjRkFyNzhMVGNWcVhtMTA9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"
}'

}

mocks

readonly ORGX_CJSON=$( jq -ec '.' "$ORGX_JSON" )

if [[ -z $ORGX_CJSON ]]; then
   echo_red "ERROR: mock ORGX_CJSON is empty"
   exit
fi

set -x
./ch.config.tool.sh read        -o "$PADFED_CONFIG_JSON"
./ch.config.tool.sh read        -o "$PADFED_CONFIG_JSON" -g orderer
./ch.config.tool.sh read        -o "$PADFED_CONFIG_JSON" -g application -m AFIP -k fabric_node_ous
./ch.config.tool.sh read        -o "$PADFED_CONFIG_JSON" -g application -m AFIP -k organizational_unit_identifiers
./ch.config.tool.sh decode      -o "$PADFED_CONFIG_JSON" -g application -m AFIP -k organizational_unit_identifier

./ch.config.tool.sh add         -o "$PADFED_CONFIG_JSON" -g application -m ORGX -k org -v "$ORGX_CJSON"
./ch.config.tool.sh add         -o "$PADFED_CONFIG_JSON" -g application -m ORGX -k org -v "$ORGX_JSON"

./ch.config.tool.sh set_anchor  -o "$PADFED_CONFIG_JSON"                -m AFIP -n peer0.x -p 7051
./ch.config.tool.sh replace_crt -o "$PADFED_CONFIG_JSON"                -m AFIP -v "$BASE64_CRT" -V "$BASE64_CRT_2"
./ch.config.tool.sh add         -o "$PADFED_CONFIG_JSON"                -m AFIP -k common_ica_certs -v "$BASE64_CRT"

readonly EAPP_TX_PB="$BASE/tmp/$$.eapp.tx.pb"
./ch.config.tool.sh add         -o "$PADFED_CONFIG_JSON"                -m AFIP -k admins -v "$BASE64_CRT" -u "$EAPP_TX_PB"
check_file "$EAPP_TX_PB"

./ch.config.tool.sh set_values -o "$PADFED_CONFIG_JSON" -g Orderer -f "$KV_FILE"

./ch.config.tool.sh set_value  -o "$PADFED_CONFIG_JSON" -k preferred_max_bytes -v 100

./ch.config.tool.sh add -o "$PADFED_CONFIG_JSON" -k consenter -v "$CONSENTER"

readonly b641='"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNaakNDQWcyZ0F3SUJBZ0lRZW9ycVBFNFRZb3VZSUV0blJoQ3B1VEFLQmdncWhrak9QUVFEQWpCK01Rc3cKQ1FZRFZRUUdFd0pCVWpFTk1Bc0dBMVVFQ0JNRVEwRkNRVEVOTUFzR0ExVUVCeE1FUTBGQ1FURWNNQm9HQTFVRQpDaE1UWVdacGNDNTBjbWxpWm1Wa0xtZHZZaTVoY2pFUE1BMEdBMVVFQ3hNR1UwUkhVMGxVTVNJd0lBWURWUVFECkV4bDBiSE5qWVM1aFptbHdMblJ5YVdKbVpXUXVaMjlpTG1GeU1CNFhEVEU1TURreU9ERTNNVEF3TUZvWERUSTUKTURreU5URTNNVEF3TUZvd2ZqRUxNQWtHQTFVRUJoTUNRVkl4RFRBTEJnTlZCQWdUQkVOQlFrRXhEVEFMQmdOVgpCQWNUQkVOQlFrRXhIREFhQmdOVkJBb1RFMkZtYVhBdWRISnBZbVpsWkM1bmIySXVZWEl4RHpBTkJnTlZCQXNUCkJsTkVSMU5KVkRFaU1DQUdBMVVFQXhNWmRHeHpZMkV1WVdacGNDNTBjbWxpWm1Wa0xtZHZZaTVoY2pCWk1CTUcKQnlxR1NNNDlBZ0VHQ0NxR1NNNDlBd0VIQTBJQUJCMEI0OUpjQlpHcmxOaTY3dFJhVnFCYkJmUzlZN01tay9QVQpKQmhWNjJ0T3RXY05zZkhlbC9JS3U0Q1lQdnRYWkI4c3FmR1JWWUFpaDM0MENlNzN6aUtqYlRCck1BNEdBMVVkCkR3RUIvd1FFQXdJQnBqQWRCZ05WSFNVRUZqQVVCZ2dyQmdFRkJRY0RBZ1lJS3dZQkJRVUhBd0V3RHdZRFZSMFQKQVFIL0JBVXdBd0VCL3pBcEJnTlZIUTRFSWdRZzFkVm9wQnFQc3NWTTJISFQ2WmVuWXlTcEZzR0JhZm95Zk45WQowcTd2bWRzd0NnWUlLb1pJemowRUF3SURSd0F3UkFJZ1N4djNCTU5FTzBWNHZGVkpQUkJxZnY3eTU1K1UreHdHCnIweUZMMGIxdnBzQ0lCa2VZR1JUVjlaM0poNy81ZjJQbEVkNmJ1V0F2Sk9jN0dBSG5DN0ZaV00rCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"'
readonly b642='"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUIyekNDQVlLZ0F3SUJBZ0lCQVRBS0JnZ3Foa2pPUFFRREFqQXpNUXN3Q1FZRFZRUUdFd0pCVWpFTk1Bc0cKQTFVRUNnd0VRVVpKVURFVk1CTUdBMVVFQXd3TVFVWkpVQ0JTYjI5MElFTkJNQjRYRFRFNU1USXhOakV5TkRFMApPRm9YRFRJNU1USXhNekV5TkRFME9Gb3dWREVMTUFrR0ExVUVCaE1DUVZJeERUQUxCZ05WQkFvTUJFRkdTVkF4Ck5qQTBCZ05WQkFNTUxXMXpjR2xqWVM1aWJHOWphMk5vWVdsdUxYUnlhV0oxZEdGeWFXRXVhRzl0Ynk1aFptbHcKTG1kdllpNWhjakJaTUJNR0J5cUdTTTQ5QWdFR0NDcUdTTTQ5QXdFSEEwSUFCRVF0aEJrMUFic2sycXYrS3h6MgpmbEVSR1FQa0FIaXhlRHFPOUhmdS9DQmloYVBTRkhlUFNIcFk3WmNudkJtOG5yR01uOTN3cFZQbnpuUlZQR09zCnA4ZWpaakJrTUIwR0ExVWREZ1FXQkJRTE94RWU0bi90Wk1BWVZ0Vm52bmQ4R2JRQWdqQWZCZ05WSFNNRUdEQVcKZ0JSZmZEVEJLT0g2NzdDRWZwVXZ2U2tTYUJtTVp6QVNCZ05WSFJNQkFmOEVDREFHQVFIL0FnRUFNQTRHQTFVZApEd0VCL3dRRUF3SUJoakFLQmdncWhrak9QUVFEQWdOSEFEQkVBaUErRXMxMGljeWZQRlNzRFBnc2VPNmR2RUJCCmJmeFpxaTFNUktabjR4WldCd0lnR21Oa3lKcEQ4YjdxdUV2eUxnVHFROUd4dDd6Mnk4OTA4bFBCTzBlZkNTbz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="'

./ch.config.tool.sh set_value -o "$PADFED_CONFIG_JSON" -m AFIP -k tls_root_certs -v "[$b641]"

readonly organizational_unit_identifier='"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUIyekNDQVlLZ0F3SUJBZ0lCQVRBS0JnZ3Foa2pPUFFRREFqQXpNUXN3Q1FZRFZRUUdFd0pCVWpFTk1Bc0cKQTFVRUNnd0VRVVpKVURFVk1CTUdBMVVFQXd3TVFVWkpVQ0JTYjI5MElFTkJNQjRYRFRFNU1USXhOakV5TkRFMApPRm9YRFRJNU1USXhNekV5TkRFME9Gb3dWREVMTUFrR0ExVUVCaE1DUVZJeERUQUxCZ05WQkFvTUJFRkdTVkF4Ck5qQTBCZ05WQkFNTUxXMXpjR2xqWVM1aWJHOWphMk5vWVdsdUxYUnlhV0oxZEdGeWFXRXVhRzl0Ynk1aFptbHcKTG1kdllpNWhjakJaTUJNR0J5cUdTTTQ5QWdFR0NDcUdTTTQ5QXdFSEEwSUFCRVF0aEJrMUFic2sycXYrS3h6MgpmbEVSR1FQa0FIaXhlRHFPOUhmdS9DQmloYVBTRkhlUFNIcFk3WmNudkJtOG5yR01uOTN3cFZQbnpuUlZQR09zCnA4ZWpaakJrTUIwR0ExVWREZ1FXQkJRTE94RWU0bi90Wk1BWVZ0Vm52bmQ4R2JRQWdqQWZCZ05WSFNNRUdEQVcKZ0JSZmZEVEJLT0g2NzdDRWZwVXZ2U2tTYUJtTVp6QVNCZ05WSFJNQkFmOEVDREFHQVFIL0FnRUFNQTRHQTFVZApEd0VCL3dRRUF3SUJoakFLQmdncWhrak9QUVFEQWdOSEFEQkVBaUErRXMxMGljeWZQRlNzRFBnc2VPNmR2RUJCCmJmeFpxaTFNUktabjR4WldCd0lnR21Oa3lKcEQ4YjdxdUV2eUxnVHFROUd4dDd6Mnk4OTA4bFBCTzBlZkNTbz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="'
./ch.config.tool.sh set_value -o "$PADFED_CONFIG_JSON" -m AFIP -k organizational_unit_identifier -v "$b642"

readonly organizational_unit_identifiers="[
{	\"certificate\": $b641, \"organizational_unit_identifier\": \"MSP-TRIBUTARIA\" },
{	\"certificate\": $b642, \"organizational_unit_identifier\": \"MSP-TRIBUTARIA\" }
]"

./ch.config.tool.sh set_value -o "$PADFED_CONFIG_JSON" -m AFIP -k organizational_unit_identifiers -v "$organizational_unit_identifiers"

set +x

echo_success
